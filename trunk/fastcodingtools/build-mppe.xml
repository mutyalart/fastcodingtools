<!--
Script de Build para o Sistema SGA
-->
<project name="ColetaMetricas" default="buildall" basedir=".">

<!-- *********************************************************************** --> 
<!--	                           PROPERTIES                                -->
<!-- *********************************************************************** -->	
        <!-- Variáveis Principais para localização dos diretórios -->
		<!-- <property file="build.properties" />-->

    <property environment="env" />

    <property name="java_home" value="${env.JAVA_HOME}" />
    <property name="tomcat_home" value="${env.CATALINA_HOME}" />

    <property name="workspace" value=".." />
    <property name="deploy.dir" value="${workspace}/Web/" />
	<property name="src.web" value="${deploy.dir}/JavaSource" />
	<property name="bin.web" value="${deploy.dir}/WebContent/WEB-INF/classes" />
	<property name="currectProject" value="Web" />
	<property name="resources.projects.jar" value="${workspace}/Recursos/projects" />
	
	<property name="app.name" value="sga" />
	<property name="path" value="/${app.name}" />
	<property name="url" value="http://localhost:8080/manager" />
	<property name="username" value="admin" />
	<property name="password" value="admin" />

    <property name="tomcat.work.app.dir" value="${tomcat_home}/work/Catalina/localhost/${path}" />

	<property name="webapp.war.dir" value="dist" />
	<property name="webapp.war.nome" value="${app.name}.war" />
	<property name="webapp.path" value="${deploy.dir}/WebContent" />

	<property name="src" value="src" />
	<property name="bin" value="bin" />
	
	<!-- Variáveis de métricas -->
	<property name="metrics.path" value="${env.METRICAS_PATH}"/>
    <property name="metrics.dir" value="${metrics.path}/metricas"/>
    <property name="test.dir" value="${metrics.path}/testes"/>

    <!-- metricas -->
    <property name="metrics.dir.oo" value="${metrics.dir}/oo"/>
    <property name="metrics.dir.code" value="${metrics.dir}/code"/>
    <property name="metrics.dir.quality" value="${metrics.dir}/quality"/>
    <property name="metrics.java.source" value="${metrics.dir}/src"/>
    <property name="metrics.java.classes" value="${metrics.dir}/bin"/>
    <property name="metrics.xsl.dir" value="${workspace}/Recursos/metricas/xsl"/>
    <property name="metrics.pmdrules.dir" value="${metrics.dir}/pmd"/>
	
	<!-- Relatórios -->
	<property name="reports.src" value="${webapp.path}/WEB-INF/report"/>
	<property name="reports.build" value="${webapp.path}/WEB-INF/report"/>
	
<!-- *********************************************************************** --> 
<!--	                          TASK DEFINITIONS                           -->
<!-- *********************************************************************** -->
	  <taskdef name="deploy"
	  		   classname="org.apache.catalina.ant.DeployTask">
    	<classpath refid="ant.class.path"/>
      </taskdef>
	
	  <taskdef name="list"      
	  	       classname="org.apache.catalina.ant.ListTask">
    	<classpath refid="ant.class.path"/>
    </taskdef>
	
	  <taskdef name="reload"    
	  	       classname="org.apache.catalina.ant.ReloadTask">
    	<classpath refid="ant.class.path"/>
    </taskdef>
	
	  <taskdef name="resources" 
	  	       classname="org.apache.catalina.ant.ResourcesTask">
    	<classpath refid="ant.class.path"/>
    </taskdef>
	
	  <taskdef name="roles"     
	  	       classname="org.apache.catalina.ant.RolesTask">
    	<classpath refid="ant.class.path"/>
    </taskdef>
	
	  <taskdef name="start"     
	  	       classname="org.apache.catalina.ant.StartTask">
    	<classpath refid="ant.class.path"/>
    </taskdef>
	
	  <taskdef name="stop"      
	  	       classname="org.apache.catalina.ant.StopTask">
    	<classpath refid="ant.class.path"/>
    </taskdef>
    		
	  <taskdef name="undeploy"  
	  	       classname="org.apache.catalina.ant.UndeployTask">
    	<classpath refid="ant.class.path"/>
    </taskdef>
    		
    <taskdef classname="org.apache.jasper.JspC" name="jasper2">
    	<classpath refid="jspc.class.path"/>
    </taskdef>	

    <taskdef name="javancss" classname="javancss.JavancssAntTask">
    	<classpath refid="ant.class.path"/>
    </taskdef>
    	
    <taskdef name="pmd" classname="net.sourceforge.pmd.ant.PMDTask">
    	<classpath refid="ant.class.path"/>
    </taskdef>

	<taskdef name="jrc" 
	      classname="net.sf.jasperreports.ant.JRAntCompileTask"> 
		<classpath refid="class.path"/>
	</taskdef>	
	
<!-- *********************************************************************** --> 
<!--	                     CLASS PATH DEFINITIONS                          -->
<!-- *********************************************************************** -->	
    <!-- Classpath do sistema -->
	<path id="class.path">
		<pathelement location="${bin}"/>
		<fileset dir="${workspace}/Recursos">
			<include name="**/*.jar"/>
		</fileset>
	</path>

	<path id="ant.class.path">
		<fileset dir="${workspace}/Recursos/lib/ant">
			<include name="**/*.jar"/>
		</fileset>
	</path>	
	
    <path id="jspc.class.path"> 
      <pathelement location="${java_home}/lib/tools.jar"/> 
      <fileset dir="${tomcat_home}/bin"> 
        <include name="*.jar"/> 
      </fileset> 
      <fileset dir="${tomcat_home}/server/lib"> 
        <include name="*.jar"/> 
      </fileset> 
      <fileset dir="${tomcat_home}/common/lib"> 
        <include name="*.jar"/> 
      </fileset> 
    </path>	
	
	
<!-- *********************************************************************** --> 
<!--	                              TARGETS                                -->
<!-- *********************************************************************** -->	
	
        <!-- Alvo auxiliar que compila um dos módulos do sistema, especificado em ${currectProject}-->
        <target name="buildCurrentPoject">
                <mkdir dir="${workspace}/${currectProject}/${bin}"/>
                <javac 	destdir="${workspace}/${currectProject}/${bin}" 
                	   	deprecation="yes" 
                		encoding="iso-8859-1" 
                		debug="true"
                		source="1.4">
                        <classpath refid="class.path"/>
                        <src path="${workspace}/${currectProject}/${src}"/>
                </javac>
                <copy todir="${workspace}/${currectProject}/${bin}">
                        <fileset dir="${workspace}/${currectProject}/${src}">
                                <exclude name="**/*.java"/>
                        </fileset>
                </copy>
                <jar destfile="${resources.projects.jar}/${currectProject}.jar">
                        <fileset dir="${workspace}/${currectProject}/${bin}"/>
                </jar>
        </target>

        <!-- Compila o projeto Web de forma diferenciada -->
        <target name="buildWebPoject">
                <mkdir dir="${bin.web}"/>
                <javac destdir="${bin.web}" deprecation="yes" 
                    source="1.4">
                        <classpath refid="class.path"/>
                        <src path="${src.web}"/>
                </javac>
                <copy todir="${bin.web}">
                        <fileset dir="${src.web}">
                            <exclude name="**/*.java"/>
                        	<exclude name="**/*.jrxml"/>
                        	<exclude name="**/*.bak"/>
                        </fileset>
                </copy>
                <copy todir="${workspace}/Web/WebContent/WEB-INF/lib" flatten="yes">
                        <fileset dir="${workspace}/Recursos">
                                <include name="**/*.jar"/>
                                <exclude name="**/javax.servlet.jar"/>
                                <exclude name="**/javax.servlet.jsp.jar"/>
                        </fileset>
                </copy>
        </target>


        <!-- Compila todos os projetos do sistema -->
        <target name="buildall">
	        	<mkdir dir="${resources.projects.jar}"/>
                <antcall target="buildCurrentPoject">
                        <param name="currectProject" value="Infra"/>
                </antcall>
	            <antcall target="buildCurrentPoject">
	                    <param name="currectProject" value="Endereco"/>
	            </antcall>        	
                <antcall target="buildCurrentPoject">
                        <param name="currectProject" value="Comum"/>
                </antcall>
                <antcall target="buildCurrentPoject">
                        <param name="currectProject" value="ControleAcesso"/>
                </antcall>
				<antcall target="buildCurrentPoject">
		                <param name="currectProject" value="Auditoria"/>
		        </antcall>
	            <antcall target="buildCurrentPoject">
	                    <param name="currectProject" value="Servidor"/>
	            </antcall>
	            <antcall target="buildCurrentPoject">
	                    <param name="currectProject" value="Pessoa"/>
	            </antcall>
	            <antcall target="buildCurrentPoject">
	                    <param name="currectProject" value="Documento"/>
	            </antcall>        	
        		<antcall target="buildCurrentPoject">
                        <param name="currectProject" value="Importacao"/>
                </antcall>
			    <antcall target="buildCurrentPoject">
	                    <param name="currectProject" value="Pesquisas"/>
	            </antcall>
		        <antcall target="buildCurrentPoject">
		                <param name="currectProject" value="Modelo"/>
		        </antcall>				
				<antcall target="buildCurrentPoject">
		                <param name="currectProject" value="ManterGenerico"/>
		        </antcall>
				<antcall target="buildCurrentPoject">
		                <param name="currectProject" value="Relatorios"/>
		        </antcall>         
        	
        		<antcall target="buildWebPoject"/>
        		<antcall target="buildReports"/>
        </target>
	
	<!-- ================================= 
          CLEAR              
         =================================-->
	<target name="clearCurrentProject">
		<delete dir="${workspace}/${currectProject}/${bin}" quiet="true"/>
		<mkdir dir="${workspace}/${currectProject}/${bin}"/>
	</target>
	
	<!-- ================================= 
          CLEAR ALL             
         =================================-->	
    <target name="clearAll">
            <antcall target="clearCurrentProject">
                    <param name="currectProject" value="Infra"/>
            </antcall>
            <antcall target="clearCurrentProject">
                    <param name="currectProject" value="Endereco"/>
            </antcall>    	
            <antcall target="clearCurrentProject">
                    <param name="currectProject" value="Comum"/>
            </antcall>
            <antcall target="clearCurrentProject">
                    <param name="currectProject" value="ControleAcesso"/>
            </antcall>
    		<antcall target="clearCurrentProject">
                    <param name="currectProject" value="Pessoa"/>
            </antcall>    	
	        <antcall target="clearCurrentProject">
	                <param name="currectProject" value="Servidor"/>
	        </antcall>    	
	        <antcall target="clearCurrentProject">
	                <param name="currectProject" value="Documento"/>
	        </antcall>
            <antcall target="clearCurrentProject">
                    <param name="currectProject" value="Importacao"/>
            </antcall>
			<antcall target="clearCurrentProject">
		            <param name="currectProject" value="Pesquisas"/>
		    </antcall>    	
	        <antcall target="clearCurrentProject">
	                <param name="currectProject" value="Modelo"/>
	        </antcall>
			<antcall target="clearCurrentProject">
	                <param name="currectProject" value="ManterGenerico"/>
	        </antcall>		
			<antcall target="clearCurrentProject">
	                <param name="currectProject" value="Auditoria"/>
	        </antcall>

		<delete dir="${resources.projects.jar}" quiet="true"/>    	
		<mkdir dir="${resources.projects.jar}"/>
    	
		<delete dir="${webapp.path}/WEB-INF/classes" quiet="true"/>    	
		<mkdir dir="${webapp.path}/WEB-INF/classes"/>
    	
    	<delete dir="${webapp.path}/WEB-INF/lib" quiet="true"/>    	
		<mkdir dir="${webapp.path}/WEB-INF/lib"/>    	
    	
    </target>	
	
	
	<!-- Tasks relacionadas com o uso do tomcat -->
	
	<!-- ================================= 
	          RUN TOMCAT              
	         ================================= -->		
	  <target name="run-tomcat" description="start tomcat server">
	  	
			<exec executable="${tomcat_home}/bin/catalina.bat">
				<arg value="run"/>
	  		</exec>
	  </target>	
	
	<!-- ================================= 
	          RUN TOMCAT              
	         ================================= -->		
	  <target name="debug-tomcat" description="start tomcat server">
	  	
			<exec executable="${tomcat_home}/bin/catalina.bat">
				<arg value="-debug"/>
	  		</exec>
	  </target>		
	
	<!-- ================================= 
	          STOP TOMCAT              
	         ================================= -->		
	  <target name="stop-tomcat" description="start tomcat server">
	  	
			<exec executable="${tomcat_home}/bin/catalina.bat">
				<arg value="stop"/>
	  		</exec>
	  </target>		
	
	<!-- ================================= 
	          START CONTEXT              
	         ================================= -->		
	  <target name="start-context" description="Reload web application">
	  	
	    <start  url="${url}" username="${username}" password="${password}"
	            path="${path}"/>
	  </target>		

	<!-- ================================= 
	          STOP CONTEXT              
	         ================================= -->			
	  <target name="stop-context" description="Reload web application">
	  	
	    <stop  url="${url}" username="${username}" password="${password}"
	            path="${path}"/>
	  </target>	
	
	<!-- ================================= 
	          RELOAD CONTEXT              
	         ================================= -->				
	  <target name="reload-context" description="Reload web application">
	  	
	  	<reload  url="${url}" username="${username}" password="${password}"
	            path="${path}"/>
	  </target>	
	

	<!-- ================================= 
	          CLEAR TOMCAT CACHE              
	         ================================= -->			
	<target name="clear-tomcat-cache">
		<delete dir="${tomcat.work.app.dir}"/>
	</target>	
	
	<!-- ================================= 
	          JSPC - compilando as jsps              
	         ================================= 	-->	

	
	<target name="generate-jsps">
	
	    <jasper2 validateXml="false" 
	             uriroot="${webapp.path}" 
	             webXmlFragment="${webapp.path}/WEB-INF/web.xml" 
	             outputDir="${tomcat.work.app.dir}"/> 
	</target>
	
	
	<target name="jspc" depends="generate-jsps"> 
		
		<javac srcdir="${tomcat.work.app.dir}" 
			   destdir="${tomcat.work.app.dir}"
	           optimize="true"
			   debug="false"
			   verbose="true"
			   nowarn="false">
			<classpath refid="class.path" />
			<classpath refid="jspc.class.path"/>
		</javac>	  	
	  	
	  </target>	
	
	<!-- ================================= 
	          WAR              
	         ================================= 	
	<target name="generate-war" depends="deploy">
	
		<war destfile="${webapp.war.dir}/${webapp.war.nome}" 
			 webxml="${webapp.path}\\WEB-INF\\web.xml">
		
		  <zipfileset dir="${webapp.path}"/>			
		</war>		
	</target>
	-->

	<!-- METRICAS METRICAS METRICAS METRICAS METRICAS METRICAS METRICAS  -->        
	
	<property name="acp" refid="ant.class.path"/>
	<property name="cp" refid="class.path"/>
	
	<target name="classpath">
		<echo message="ant.class.path is ${acp}"/>
		<echo message="class.path is ${cp}"/>		
    </target>

    <!-- Inicialização das métricas -->    
    <target name="initMetrics">
            <mkdir dir="${metrics.dir.oo}"/>
            <mkdir dir="${metrics.dir.code}"/>
            <mkdir dir="${metrics.dir.quality}"/>
            <mkdir dir="${metrics.java.source}"/>
            <mkdir dir="${metrics.java.classes}"/>
    </target>

    <target name="prepareForMetrics" depends="initMetrics, buildall">
	    <!-- junta todos os fontes para as métricas do JavaNCSS -->
        <copy todir="${metrics.java.source}">
            <fileset dir="${workspace}/Infra/src" includes="**/*.java"/>
            <fileset dir="${workspace}/Endereco/src" includes="**/*.java"/>        	
            <fileset dir="${workspace}/Comum/src" includes="**/*.java"/>
            <fileset dir="${workspace}/ControleAcesso/src" includes="**/*.java"/>
            <fileset dir="${workspace}/Pessoa/src" includes="**/*.java"/>
            <fileset dir="${workspace}/Servidor/src" includes="**/*.java"/>
            <fileset dir="${workspace}/Documento/src" includes="**/*.java"/>
            <fileset dir="${workspace}/Importacao/src" includes="**/*.java"/>
			<fileset dir="${workspace}/Pesquisas/src" includes="**/*.java"/>
            <fileset dir="${workspace}/Modelo/src" includes="**/*.java"/>
            <fileset dir="${workspace}/ManterGenerico/src" includes="**/*.java"/>
            <fileset dir="${workspace}/Auditoria/src" includes="**/*.java"/>
            <fileset dir="${workspace}/Web/JavaSource" includes="**/*.java"/>
        </copy>
        <copy todir="${metrics.java.classes}">
            <fileset dir="${workspace}/Infra/bin" includes="**/*.class"/>
            <fileset dir="${workspace}/Endereco/bin" includes="**/*.class"/>        	
            <fileset dir="${workspace}/Comum/bin" includes="**/*.class"/>
            <fileset dir="${workspace}/ControleAcesso/bin" includes="**/*.class"/>
            <fileset dir="${workspace}/Pessoa/bin" includes="**/*.class"/>
            <fileset dir="${workspace}/Servidor/bin" includes="**/*.class"/>
            <fileset dir="${workspace}/Documento/bin" includes="**/*.class"/>
            <fileset dir="${workspace}/Importacao/bin" includes="**/*.class"/>
			<fileset dir="${workspace}/Pesquisas/bin" includes="**/*.class"/>
            <fileset dir="${workspace}/Modelo/bin" includes="**/*.class"/>
            <fileset dir="${workspace}/ManterGenerico/bin" includes="**/*.class"/>
            <fileset dir="${workspace}/Auditoria/bin" includes="**/*.class"/>
            <fileset dir="${workspace}/Web/WebContent/WEB-INF/classes" includes="**/*.class"/>
        </copy>
    </target>
    
            
   <!-- JavaNCSS -->
   <target name="codeMetrics" >
      <javancss srcdir="${metrics.java.source}"
            generateReport="true"
            outputfile="${metrics.dir.code}/code.xml"
            format="xml"/>

      <style basedir="${metrics.dir.code}" destdir="${metrics.dir.code}"
       extension=".html" style="${metrics.xsl.dir}/javancss2html.xsl"/>
   </target>

   <!-- JDepend -->
   <target name="ooMetrics" >
      <jdepend outputfile="${metrics.dir.oo}/oo.xml" format="xml">
        <classespath>
            <pathelement location="${metrics.java.classes}"/>
        </classespath>
     </jdepend>

     <style basedir="${metrics.dir.oo}" destdir="${metrics.dir.oo}"
       extension=".html" style="${metrics.xsl.dir}/jdepend.xsl"/>
   </target>

	<!-- Inicialização do Build, caso necessário -->
    <target name="init">
            <mkdir dir="${test.dir}"/>
            <mkdir dir="${metrics.dir.oo}"/>
            <mkdir dir="${metrics.dir.code}"/>
            <mkdir dir="${metrics.dir.quality}"/>
            <mkdir dir="${local.build}"/>
            <mkdir dir="${local.source}"/>
            <mkdir dir="${resources.projects.jar}"/>
    </target>

	
     <!-- PMD - quality metrics -->
    <target name="qualityMetrics" depends="init">
        <pmd rulesetfiles="rulesets/basic.xml,rulesets/design.xml">
            <formatter type="html" toFile="${metrics.dir.quality}/quality.html"/>
            <fileset dir="${java.source}">
                <include name="**/*.java"/>
            </fileset>
        </pmd>
    </target>


   <target name="colectAll" depends="prepareForMetrics, ooMetrics, codeMetrics"/>

<!-- TESTES UNITÁRIOS * TESTES UNITÁRIOS * TESTES UNITÁRIOS * TESTES UNITÁRIOS -->   

	<target name="test" depends="prepareForMetrics">
		<junit printsummary="yes" fork="yes" maxmemory="256M">
            <classpath refid="class.path"/>
		
			<formatter type="xml"/>
		
			<batchtest todir="${test.dir}">
				<fileset dir="${metrics.java.classes}">
				  <include name="**/Test*.class"/>
				</fileset>
			</batchtest>
		</junit>
		
		<junitreport todir="${test.dir}">
			<fileset dir="${test.dir}">
				<include name="TEST-*.xml"/>
			</fileset>
			<report format="frames" todir="${test.dir}"/>
		</junitreport>
		
	</target>

	<target name="testJud1" depends="buildall">
		<java classname="org.cesar.sga.documento.importacao.judwin1.test.Main" fork="yes" >
			<jvmarg value="-Dlog4j.debug=true"/>
			<jvmarg value="-Dlog4j.configuration=importacao.properties"/>
			<sysproperty key="metodo" value="${importacao.metodo}"/>			
			<sysproperty key="numeroDocumento" value="${importacao.numeroDocumento}"/>			
			<sysproperty key="dataHoraPauta" value="${importacao.dataHoraPauta}"/>			
			<sysproperty key="numeroGuia" value="${importacao.numeroGuia}"/>			
			<sysproperty key="codigoComplementoOrigem" value="${importacao.codigoComplementoOrigem}"/>			
			<sysproperty key="codigoOrgaoJulgador" value="${importacao.codigoOrgaoJulgador}"/>
			<sysproperty key="dataExpedicao" value="${importacao.dataExpedicao}"/>
			<classpath refid="class.path"/>
		</java>
	</target>

	<target name="testJud2" depends="buildall">
		<java Classname="org.cesar.sga.documento.importacao.judwin2.test.Main" fork="yes" >
			<jvmarg value="-Dlog4j.debug=true"/>
			<jvmarg value="-Dlog4j.configuration=importacao.properties"/>
			<sysproperty key="metodo" value="${importacao.metodo}"/>			
			<sysproperty key="numeroDocumento" value="${importacao.numeroDocumento}"/>			
			<sysproperty key="dataHoraPauta" value="${importacao.dataHoraPauta}"/>			
			<sysproperty key="numeroGuia" value="${importacao.numeroGuia}"/>			
			<sysproperty key="codigoComplementoOrigem" value="${importacao.codigoComplementoOrigem}"/>			
			<sysproperty key="codigoOrgaoJulgador" value="${importacao.codigoOrgaoJulgador}"/>
			<sysproperty key="dataExpedicao" value="${importacao.dataExpedicao}"/>
			<classpath refid="class.path"/>
		</java>
	</target>

	<!-- COMPILA OS RELATORIOS DO JASPER REPORTS -->
	
	<target name="clearReports">
		<delete dir="${bin.web}/report" quiet="true"/>
	</target>	
	
	<target name="buildReports">
		<!-- tempdir="${deploy.dir}/temp" -->
		<mkdir dir="${bin.web}/report"/>
		
		<jrc srcdir="../Relatorios/src/report"
		   	 destdir="${bin.web}/report"		   	 
		   	 keepjava="false"
		   	 xmlvalidation="false"			 
			 excludes="*.bak" >
			<classpath refid="class.path"/>
		</jrc>		
		<jrc srcdir="${src.web}/report"
		   	 destdir="${bin.web}/report"		   	 
		   	 keepjava="false"
		   	 xmlvalidation="false"			 
			 excludes="*.bak" >
			<classpath refid="class.path"/>
		</jrc>
	</target>
	
</project>
